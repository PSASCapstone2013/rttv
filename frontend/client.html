<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>PSAS - Real Time Telemetry Visualization</title>

<link rel="stylesheet" type="text/css" media="screen" href="css/masonry.css"/>

<script src="scripts/jquery.min.js"></script>
<script src="scripts/masonry.pkgd.min.js"></script>
<script src="scripts/d3.v2.js"></script>
<script src="scripts/d3_func.js"></script>
<script src="widgets/graph.js"></script>
<script src="widgets/gauge.js"></script>
</head>

<body>

<div class="container">
  <div class="widget lock">
    <h3 id="locked"></h3>
  </div>
  <div class="widget gps">
    <h3 id="gps"></h3>
  </div>
  <div class="widget acc">
    <h3 id="acceleration"></h3>
  </div>
  <div class="widget zroll_graph">
  </div>
  <div class="widget gauge">
  </div>
</div>

</body>
</html>

<script>
  // Gauge
  function createGauge(label) {
    var config =
    {
        size: 250,
        label: label,
        minorTicks: 5,
        max: 10000,
        yellowPercent: 80,
        redPercent: 90
    };

    return new Gauge(config);
  }

  var gauge = createGauge("Altitude");
  gauge.render();
  
  // Graph of Z Roll
  var rollGraph = new Graph(625, 320, Number.MAX_VALUE),
    widgets = [rollGraph, gauge];
</script>

<script>
  // Masonry
  docReady(function() {
    var container = document.querySelector('.container');
    var msnry = new Masonry( container, { columnWidth: 50 });
  });
</script>

<script>
  // Websocket
  $(function () {  
    // if user is running mozilla then use it's built-in WebSocket
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    var connection = new WebSocket('ws://localhost:8080');
    
    var oldDate = new Date();
    var oldTime = oldDate.getTime();
    var maxheight = 0;
    
    log = document.getElementById('locked');
    gps = document.getElementById('gps');
    acc = document.getElementById('acceleration');
    
    connection.onopen = function () {
      connection.send('Client Connected');
      log.innerHTML = 'connection is open' + log.innerHTML;
    };
    connection.onerror = function (error) {
      log.innerHTML = 'Rocket is <ohno>not locked</ohno>.';
    };
    connection.onclose = function () {
      log.innerHTML = 'Rocket is <ohno>not locked</ohno>.';
    };
    
    connection.onmessage = function (message) {
      // try to decode json (this script assumes that each message from the server is json)
      try {
        var json = JSON.parse(message.data);
        var newDate = new Date();
        var newTime = newDate.getTime();
        
        if (json.fieldID == 'GPS\x01'){
          //GPS Data
          log.innerHTML = 'Rocket is <ok>locked</ok>.' + 
            '<br><br>NavMode: ' + json.NavMode + 
            '<br>Satellites: ' + json.NumOfSats;
          
          var height = json.Height.toFixed(3);
          if (height > maxheight) {
            maxheight = height;
          }
          
          var gpsdata = 'Lat: &nbsp; &nbsp;' + json.Latitude.toFixed(3) + 
            '<br>Long: ' + json.Longitude.toFixed(3) + 
            '<br><br>Height: ' + height + 
            '<br>Max Height: ' + maxheight;
          gps.innerHTML = gpsdata;
          
          // send height data to gauge
          gauge.put(height);
        }
        else if (json.fieldID == 'ADIS'){
          //ADIS Data
          var acceleration = 'Acceleration: ' +
            '<br>&nbsp; X ' + json.AccelerometerX.toFixed(2) +
            '<br>&nbsp; Y ' + json.AccelerometerY.toFixed(2) + 
            '<br>&nbsp; Z ' + json.AccelerometerZ.toFixed(2) + 
            '<br>Magnitude: ' + json.AccelerometerMagn.toFixed(2);
          acc.innerHTML = acceleration;
          
          //send z roll data to graph every 300ms
          if ((newTime-oldTime) > 300){
            rollGraph.put(Math.abs(json.GyroscopeX.toFixed(2)));
            tick();
            oldTime = newTime;
          }
        }
        
      } catch (e) {
        console.log('This doesn\'t look like a valid JSON: ', message.data);
        return;
      }
    };
    
  });
</script>
